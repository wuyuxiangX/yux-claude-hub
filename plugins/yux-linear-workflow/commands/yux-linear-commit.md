# Linear Commit - Stage Changes

Make incremental commits during development, linking to Linear issue and syncing progress.

**Usage**: `/yux-linear-commit [description]`

## Input

Optional commit description (reference only, Claude auto-generates the message): $ARGUMENTS

## Workflow

### Step 1: Detect Current State

1. **Get current branch**:
   ```bash
   git branch --show-current
   ```

2. **Extract Linear issue ID** (LIN-xxx pattern)
   - If not on a Linear branch, prompt user to run `/yux-linear-start` first

3. **Read local state file**:
   - Path: `.claude/linear-tasks/<ISSUE_ID>.json`
   - Get issue_uuid for subsequent Linear API calls

4. **Check uncommitted changes**:
   ```bash
   git status --porcelain
   ```
   - If no changes, display "No changes to commit" and exit

### Step 2: Display Changed Files

Run `git status --porcelain` and categorize:

**Chinese**:
```
=== Current Changes ===

New files (3):
   [1] src/components/Login.tsx
   [2] src/utils/auth.ts
   [3] tests/login.test.ts

Modified files (2):
   [4] src/App.tsx
   [5] package.json

Deleted files (1):
   [6] src/old-login.js

Suggested to ignore (not numbered):
   - .env.local (sensitive file)
   - .DS_Store (system file)
```

**English**:
```
=== Current Changes ===

New files (3):
   [1] src/components/Login.tsx
   [2] src/utils/auth.ts
   [3] tests/login.test.ts

Modified files (2):
   [4] src/App.tsx
   [5] package.json

Deleted files (1):
   [6] src/old-login.js

Suggested to ignore (not numbered):
   - .env.local (sensitive file)
   - .DS_Store (system file)
```

### Step 3: User Selects Files to Commit

Use AskUserQuestion tool to let user choose:

**Chinese**:
```
Select files to commit:

1. Commit all changes (6 files)
2. Select specific files (enter numbers, e.g.: 1,2,4)
3. Exclude specific files (enter numbers to exclude, e.g.: -5,-6)
4. Cancel
```

**English**:
```
Select files to commit:

1. Commit all changes (6 files)
2. Select specific files (enter numbers, e.g.: 1,2,4)
3. Exclude specific files (enter numbers to exclude, e.g.: -5,-6)
4. Cancel
```

### Step 3.5: Atomic Check

**Before generating commit message, analyze atomicity of changes**:

1. **Analyze changes**:
   - Read diff of selected files
   - Determine if changes contain multiple unrelated modifications

2. **If changes contain multiple independent features**, suggest splitting:

**Chinese**:
```
Suggest splitting commit

Detected multiple independent changes:
1. UI changes: src/components/Login.tsx, src/App.tsx
2. API changes: src/api/auth.ts

Suggestion:
- First commit: UI files (select 1,2)
- Second commit: API files (select 3)

Split commit? (y/n to continue with current selection)
```

**English**:
```
Suggest splitting commit

Detected multiple independent changes:
1. UI changes: src/components/Login.tsx, src/App.tsx
2. API changes: src/api/auth.ts

Suggestion:
- First commit: UI files (select 1,2)
- Second commit: API files (select 3)

Split commit? (y/n to continue with current selection)
```

3. **If changes are atomic**, display confirmation and continue:
```
Atomic check passed (all changes belong to same feature)
```

### Step 4: Generate Commit Message

**Claude auto-generates commit message** (user input is reference only):

1. **Analyze changes**:
   - Read diff of selected files
   - Determine change type and scope

2. **Auto-determine commit message**:
   - `emoji`: Choose emoji based on type
   - `type`: feat/fix/docs/refactor/test/chore/style/perf
   - `scope`: Infer module from changed files (e.g., auth, ui, api)
   - `subject`: **Chinese** description, max 50 characters

3. **Emoji mapping**:

| Type | Emoji | Meaning |
|------|-------|---------|
| feat | âœ¨ | New feature |
| fix | ğŸ› | Bug fix |
| docs | ğŸ“ | Documentation |
| style | ğŸ’„ | Format/style |
| refactor | â™»ï¸ | Refactoring |
| perf | âš¡ï¸ | Performance |
| test | âœ… | Tests |
| build | ğŸ“¦ | Build |
| ci | ğŸ‘· | CI/CD |
| chore | ğŸ”§ | Chores |

4. **Show generated commit message** for user confirmation:

**Chinese** (when user language is Chinese):
```
ç”Ÿæˆçš„æäº¤ä¿¡æ¯ï¼š

âœ¨ feat(auth): å¢åŠ ç™»å½•ç»„ä»¶å’Œè®¤è¯å·¥å…·

**å˜æ›´å†…å®¹**
- åœ¨ `src/components` ä¸­æ·»åŠ  LoginForm.tsx ç»„ä»¶
- æ·»åŠ  `auth.ts` è®¤è¯å·¥å…·
- æ›´æ–° App.tsx é›†æˆç™»å½•è·¯ç”±

**å˜æ›´åŸå› **
ä¸ºç”¨æˆ·æä¾›ç™»å½•å…¥å£ï¼Œå®ç°åŸºç¡€è®¤è¯æµç¨‹ã€‚

Refs: LIN-456

**æäº¤è€…**
Co-Authored-By: wuyuxiang ğŸ¤– ç”± Claude AI ç”Ÿæˆ

ç¡®è®¤æäº¤? (y/ä¿®æ”¹/n)
```

**English** (when user language is English):
```
Generated commit message:

âœ¨ feat(auth): add login component and auth utilities

**What**
- Add LoginForm.tsx component in `src/components`
- Add `auth.ts` authentication utility
- Update App.tsx to integrate login route

**Why**
Provide login entry for users and implement basic authentication flow.

Refs: LIN-456

**Who**
Co-Authored-By: wuyuxiang ğŸ¤– Generated by Claude AI

Confirm? (y/modify/n)
```

5. **Format based on user language**:

   **Chinese format**:
   ```
   <emoji> <type>(<scope>): <ä¸­æ–‡ä¸»é¢˜æè¿°>

   **å˜æ›´å†…å®¹**
   - å˜æ›´ç‚¹ 1
   - å˜æ›´ç‚¹ 2

   **å˜æ›´åŸå› **
   è§£é‡ŠåŠ¨æœº

   Refs: LIN-456

   **æäº¤è€…**
   Co-Authored-By: <username> ğŸ¤– ç”± Claude AI ç”Ÿæˆ
   ```

   **English format**:
   ```
   <emoji> <type>(<scope>): <English subject>

   **What**
   - Change point 1
   - Change point 2

   **Why**
   Explain motivation

   Refs: LIN-456

   **Who**
   Co-Authored-By: <username> ğŸ¤– Generated by Claude AI
   ```

**Important rules**:
- Subject and body language must match the user's detected language
- Do NOT execute `git push`, only `git add` and `git commit`
- User manually executes `git push`

### Step 5: Execute Commit

1. **Stage selected files**:
   ```bash
   git add <file1> <file2> ...
   ```

2. **Create commit**:
   ```bash
   git commit -m "<message>"
   ```

3. **Display commit result**:

**Chinese**:
```
Committed 4 files

Commit hash: abc1234
Message: feat(auth): add login component
Related Issue: LIN-456
```

**English**:
```
Committed 4 files

Commit hash: abc1234
Message: feat(auth): add login component
Related Issue: LIN-456
```

### Step 6: Sync to Linear (Required)

After successful commit, **must** add comment to Linear issue:

```
mcp__linear__create_comment(
  issueId: "<issue-uuid>",
  body: "**Commit**: `abc1234`\n\n```\nfeat(auth): add login component\n```\n\n**Files changed**: 4\n- src/components/Login.tsx\n- src/utils/auth.ts\n- ..."
)
```

Display sync result:

**Chinese**:
```
Synced to Linear: LIN-456
```

**English**:
```
Synced to Linear: LIN-456
```

### Step 7: Output Completion Summary

**Chinese**:
```
=== Commit Complete ===

Commit hash: abc1234
Message: feat(auth): add login component
Files: 4
Linear: LIN-456

Next steps:
- Continue development
- /yux-linear-commit to commit again
- /yux-linear-pr to create PR
- git push (manual)
```

**English**:
```
=== Commit Complete ===

Commit hash: abc1234
Message: feat(auth): add login component
Files: 4
Linear: LIN-456

Next steps:
- Continue development
- /yux-linear-commit to commit again
- /yux-linear-pr to create PR
- git push (manual)
```

## Special File Handling

### Auto-suggested Ignore Patterns

| Pattern | Reason |
|---------|--------|
| `.env*` | Sensitive config |
| `*.local` | Local config |
| `node_modules/**` | Dependencies |
| `.DS_Store` | macOS system file |
| `Thumbs.db` | Windows system file |
| `*.log` | Log files |
| `credentials*` | Credential files |
| `*.key` | Key files |
| `*.pem` | Certificate files |
| `.claude/` | Claude config (except linear-tasks) |

### Handling

- These files shown in "Suggested to ignore" list
- Not auto-numbered, user must explicitly select to commit
- If user forces commit of sensitive files, show warning confirmation

## Error Handling

### Not on Linear Branch

**Chinese**:
```
Not on a Linear branch

Current branch: main

Please run /yux-linear-start to create a task branch first.
```

**English**:
```
Not on a Linear branch

Current branch: main

Please run /yux-linear-start to create a task branch first.
```

### No Local State File

**Chinese**:
```
Local state file not found

Please run /yux-linear-status to sync state before committing.
```

**English**:
```
Local state file not found

Please run /yux-linear-status to sync state before committing.
```

### No Changes

**Chinese**:
```
No changes to commit

Working directory is clean.
```

**English**:
```
No changes to commit

Working directory is clean.
```

### Commit Failed

**Chinese**:
```
Commit failed

Error: <git error message>

Please fix the issue and try again.
```

**English**:
```
Commit failed

Error: <git error message>

Please fix the issue and try again.
```

### Linear Sync Failed

**Chinese**:
```
Linear sync failed

Commit completed (abc1234), but failed to sync to Linear.
Error: <error message>

Please manually record this commit on Linear.
```

**English**:
```
Linear sync failed

Commit completed (abc1234), but failed to sync to Linear.
Error: <error message>

Please manually record this commit on Linear.
```

## Examples

### Example 1: Standard Flow (Chinese)

```
User: /yux-linear-commit å®ç°äº†ç™»å½•è¡¨å•

Claude:
=== å½“å‰å˜æ›´ ===

æ–°å¢æ–‡ä»¶ (1):
   [1] src/components/LoginForm.tsx

ä¿®æ”¹æ–‡ä»¶ (2):
   [2] src/App.tsx
   [3] src/routes/index.ts

é€‰æ‹©è¦æäº¤çš„æ–‡ä»¶ï¼š
1. æäº¤æ‰€æœ‰å˜æ›´ (3 ä¸ªæ–‡ä»¶)
2. é€‰æ‹©ç‰¹å®šæ–‡ä»¶
3. æ’é™¤ç‰¹å®šæ–‡ä»¶
4. å–æ¶ˆ

User: 1

Claude:
âœ“ åŸå­æ€§æ£€æŸ¥é€šè¿‡ï¼ˆæ‰€æœ‰å˜æ›´å±äºåŒä¸€åŠŸèƒ½ï¼‰

ç”Ÿæˆçš„æäº¤ä¿¡æ¯ï¼š

âœ¨ feat(auth): å¢åŠ ç™»å½•è¡¨å•ç»„ä»¶å’Œè·¯ç”±é›†æˆ

**å˜æ›´å†…å®¹**
- åˆ›å»º `LoginForm.tsx` ç»„ä»¶ç”¨äºç”¨æˆ·ç™»å½•ç•Œé¢
- æ›´æ–° `App.tsx` é›†æˆç™»å½•ç»„ä»¶
- æ›´æ–° `routes/index.ts` æ·»åŠ ç™»å½•è·¯ç”±

**å˜æ›´åŸå› **
ä¸ºç”¨æˆ·æä¾›ç™»å½•å…¥å£ï¼Œå®ç°åŸºç¡€è®¤è¯æµç¨‹ã€‚

Refs: LIN-456

**æäº¤è€…**
Co-Authored-By: wuyuxiang ğŸ¤– ç”± Claude AI ç”Ÿæˆ

ç¡®è®¤æäº¤? (y/ä¿®æ”¹/n)

User: y

Claude:
å·²æäº¤ 3 ä¸ªæ–‡ä»¶
å·²åŒæ­¥åˆ° Linear: LIN-456

=== æäº¤å®Œæˆ ===

Commit hash: a1b2c3d
Linear: LIN-456

ä¸‹ä¸€æ­¥ï¼š
- ç»§ç»­å¼€å‘
- /yux-linear-commit å†æ¬¡æäº¤
- /yux-linear-pr åˆ›å»º PR
- git push (æ‰‹åŠ¨æ‰§è¡Œ)
```

### Example 2: Selective Commit (Chinese)

```
User: /yux-linear-commit

Claude:
=== å½“å‰å˜æ›´ ===

æ–°å¢æ–‡ä»¶ (1):
   [1] src/utils/auth.ts

ä¿®æ”¹æ–‡ä»¶ (3):
   [2] src/App.tsx
   [3] package.json
   [4] package-lock.json

é€‰æ‹©è¦æäº¤çš„æ–‡ä»¶ï¼š
...

User: 1,2

Claude:
âœ“ åŸå­æ€§æ£€æŸ¥é€šè¿‡

ç”Ÿæˆçš„æäº¤ä¿¡æ¯ï¼š

âœ¨ feat(auth): å¢åŠ è®¤è¯å·¥å…·æ¨¡å—

**å˜æ›´å†…å®¹**
- åˆ›å»º `auth.ts` è®¤è¯å·¥å…·
- æ›´æ–° `App.tsx` é›†æˆè®¤è¯æ¨¡å—

**å˜æ›´åŸå› **
æä¾›ç»Ÿä¸€çš„è®¤è¯é€»è¾‘å¤„ç†ã€‚

Refs: LIN-456

**æäº¤è€…**
Co-Authored-By: wuyuxiang ğŸ¤– ç”± Claude AI ç”Ÿæˆ

ç¡®è®¤æäº¤? (y/ä¿®æ”¹/n)

User: y

Claude:
å·²æäº¤ 2 ä¸ªæ–‡ä»¶
å·²åŒæ­¥åˆ° Linear: LIN-456
...
```

### Example 3: Modify Commit Message (Chinese)

```
User: /yux-linear-commit

Claude:
...

ç”Ÿæˆçš„æäº¤ä¿¡æ¯ï¼š

âœ¨ feat(auth): å¢åŠ ç™»å½•éªŒè¯

**å˜æ›´å†…å®¹**
- æ·»åŠ ç™»å½•éªŒè¯é€»è¾‘

**å˜æ›´åŸå› **
ç¡®ä¿ç”¨æˆ·è¾“å…¥æœ‰æ•ˆã€‚

Refs: LIN-456

**æäº¤è€…**
Co-Authored-By: wuyuxiang ğŸ¤– ç”± Claude AI ç”Ÿæˆ

ç¡®è®¤æäº¤? (y/ä¿®æ”¹/n)

User: æ”¹æˆ fix ç±»å‹ï¼Œä¿®å¤éªŒè¯é€»è¾‘

Claude:
ä¿®æ”¹åçš„æäº¤ä¿¡æ¯ï¼š

ğŸ› fix(auth): ä¿®å¤ç™»å½•éªŒè¯é€»è¾‘

**å˜æ›´å†…å®¹**
- ä¿®å¤ç™»å½•éªŒè¯é€»è¾‘ä¸­çš„è¾¹ç•Œæ¡ä»¶

**å˜æ›´åŸå› **
è§£å†³ç”¨æˆ·æ— æ³•æ­£å¸¸ç™»å½•çš„é—®é¢˜ã€‚

Refs: LIN-456

**æäº¤è€…**
Co-Authored-By: wuyuxiang ğŸ¤– ç”± Claude AI ç”Ÿæˆ

ç¡®è®¤æäº¤? (y/ä¿®æ”¹/n)

User: y

Claude:
å·²æäº¤ 2 ä¸ªæ–‡ä»¶
...
```
